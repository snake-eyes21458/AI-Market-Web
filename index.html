<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Market Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; color: #333; }
    input, button { padding: 10px; font-size: 16px; margin: 10px 0; }
    .results { background: #fff; border-radius: 8px; padding: 20px; margin-top: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2 { color: #2c3e50; }
    canvas { max-width: 600px; margin-top: 20px; }
    label { display: block; margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>AI Market Analyzer</h1>
  <label for="productType">Enter a product type:</label>
  <input type="text" id="productType" placeholder="e.g., thermostats" />
  <div id="progressBarContainer" style="width:100%; background:#ddd; height:10px; display:none; margin-top:10px;">
    <div id="progressBar" style="width:0%; height:10px; background:#3498db;"></div>
  </div>
  <button onclick="analyze()">Analyze</button>

  <div class="results" id="results" style="display:none">
    <h2>Results</h2>
    <p><strong>Competitors:</strong> <span id="competitors"></span></p>
    <p><strong>Average Price (USD):</strong> $<span id="avgPrice"></span></p>
    <p><strong>Repair Rate:</strong> <span id="repairRate"></span>%</p>
    <p><strong>Opportunity Score:</strong> <span id="opportunityScore"></span>/100</p>
    <p><strong>Recommendation:</strong> <span id="recommendation"></span></p>
    <p><strong>Trend Growth:</strong> <span id="trendGrowthPercent"></span>%</p>

    <canvas id="salesChart"></canvas>
    <canvas id="trendChart"></canvas>
  </div>

  <script>
    async function analyze() {
      const type = document.getElementById('productType').value;
      document.getElementById('results').style.display = 'none';
      document.getElementById('progressBarContainer').style.display = 'block';
      document.getElementById('progressBar').style.width = '0%';

      // Animate progress bar to simulate loading
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 95) progress = 95;
        document.getElementById('progressBar').style.width = progress + '%';
      }, 200);

      const res = await fetch('/api/market-data?type=' + encodeURIComponent(type));
      const data = await res.json();

      document.getElementById('results').style.display = 'block';
      document.getElementById('competitors').textContent = data.competitors.join(', ');
      document.getElementById('avgPrice').textContent = data.avgPrice;
      document.getElementById('repairRate').textContent = data.repairRate;
      document.getElementById('opportunityScore').textContent = data.opportunityScore;
      document.getElementById('recommendation').textContent = data.recommendation;
      document.getElementById('trendGrowthPercent').textContent = data.trendGrowthPercent;
      clearInterval(interval);
      document.getElementById('progressBar').style.width = '100%';
      setTimeout(() => document.getElementById('progressBarContainer').style.display = 'none', 500);

      renderBarChart('salesChart', 'Annual Sales by Region (Units)', data.salesByCountry);
      renderLineChart('trendChart', 'Estimated Monthly Search Volume (Thousands)', data.trendData);
    }

    function renderBarChart(canvasId, label, dataObj) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = Object.keys(dataObj);
      const values = Object.values(dataObj);
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label, data: values, backgroundColor: '#3498db' }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: label }
          },
          scales: {
            x: { title: { display: true, text: 'Region' } },
            y: { title: { display: true, text: 'Units' } }
          }
        }
      });
    }

    function renderLineChart(canvasId, label, trend) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: trend.labels.map(label => label.length === 4 ? label : label),
          datasets: [{ label, data: trend.values, borderColor: '#2ecc71', fill: false }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: label }
          },
          scales: {
            x: { title: { display: true, text: 'Month' } },
            y: { title: { display: true, text: 'Search Volume (k)' } }
          }
        }
      });
    }
  </script>
</body>
</html>
